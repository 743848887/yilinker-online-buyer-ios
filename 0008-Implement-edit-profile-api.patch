From adc8d21a33bcda8af5763b4246601946ba8dd8e2 Mon Sep 17 00:00:00 2001
From: jpChan15 <john.chan@easyshop.ph>
Date: Fri, 28 Aug 2015 14:03:48 +0800
Subject: [PATCH 08/27] Implement edit profile api.

---
 .../resources/Helper/APIManager.swift              |  1 +
 .../EditProfileTableViewController.swift           | 90 +++++++++++++++++++++-
 .../ViewController/SearchViewController.swift      |  4 -
 .../ViewController/WishlistViewController.swift    |  1 -
 4 files changed, 90 insertions(+), 6 deletions(-)

diff --git a/YiLinkerOnlineBuyer/resources/Helper/APIManager.swift b/YiLinkerOnlineBuyer/resources/Helper/APIManager.swift
index 888ae2a..493c871 100644
--- a/YiLinkerOnlineBuyer/resources/Helper/APIManager.swift
+++ b/YiLinkerOnlineBuyer/resources/Helper/APIManager.swift
@@ -39,6 +39,7 @@ struct APIAtlas {
     static let productPageUrl = "v1/get-product"
     static let searchUrl = "product/getSearchKeywords"
     static let profileUrl = "auth/user/getUser"
+    static let editProfileUrl = "auth/user/editProfile"
     static let baseUrl = APIEnvironment.baseUrl()
 }
 
diff --git a/YiLinkerOnlineBuyer/resources/ViewController/EditProfileTableViewController.swift b/YiLinkerOnlineBuyer/resources/ViewController/EditProfileTableViewController.swift
index 7b77826..0fbc2c0 100644
--- a/YiLinkerOnlineBuyer/resources/ViewController/EditProfileTableViewController.swift
+++ b/YiLinkerOnlineBuyer/resources/ViewController/EditProfileTableViewController.swift
@@ -10,6 +10,8 @@ import UIKit
 
 class EditProfileTableViewController: UITableViewController, UINavigationControllerDelegate, EditProfileAddPhotoTableViewCellDelegate, EditProfileAddressTableViewCellDelegate, EditProfileAccountInformationTableViewCellDelegate, UIImagePickerControllerDelegate, UIActionSheetDelegate  {
     
+    let manager = APIManager.sharedInstance
+    
     let addPhotoCellIndetifier: String = "EditProfileAddPhotoTableViewCell"
     let personalInfoCellIdentifier: String = "EditProfilePersonalInformationTableViewCell"
     let addressCellIdentifier: String = "EditProfileAddressTableViewCell"
@@ -127,7 +129,6 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
         } else if indexPath.row == 2 {
             let cell = tableView.dequeueReusableCellWithIdentifier(addressCellIdentifier, forIndexPath: indexPath) as! EditProfileAddressTableViewCell
             cell.delegate = self
-            
             addressIndexPath = indexPath
             
             return cell
@@ -333,6 +334,93 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
         
         if errorMessage != "" {
             UIAlertController.displayErrorMessageWithTarget(self, errorMessage: errorMessage)
+        } else {
+            if Reachability.isConnectedToNetwork(){
+                var params: NSDictionary = [
+                    "firstName": firstName! as String,
+                    "lastName": lastName! as String,
+                    "contactNumber": mobileNumber! as String,
+                    "access_token": SessionManager.accessToken()]
+                
+                fireUpdateProfile(APIAtlas.editProfileUrl, params: params)
+            }
+            else {
+                showAlert("Connection Unreachable", message: "Cannot retrieve data. Please check your internet connection.")
+            }
         }
+            
+    }
+    
+    
+    func fireUpdateProfile(url: String, params: NSDictionary!) {
+        showLoader()
+        manager.POST(url, parameters: params, success: {
+            (task: NSURLSessionDataTask!, responseObject: AnyObject!) in print(responseObject as! NSDictionary)
+            if responseObject.objectForKey("error") != nil {
+                self.requestRefreshToken("updateProfile", url: url, params: params)
+            }
+            self.dismissLoader()
+            self.showAlert("Success", message: "Successfully updated profile!")
+            }, failure: {
+                (task: NSURLSessionDataTask!, error: NSError!) in
+                self.showAlert("Error", message: "Something went wrong. . .")
+                self.dismissLoader()
+        })
     }
+    
+    //Loader function
+    func showLoader() {
+        SVProgressHUD.show()
+        SVProgressHUD.setBackgroundColor(UIColor.whiteColor())
+    }
+    
+    func dismissLoader() {
+        SVProgressHUD.dismiss()
+    }
+    
+    func requestRefreshToken(type: String, url: String, params: NSDictionary!) {
+        let url: String = "http://online.api.easydeal.ph/api/v1/login"
+        let params: NSDictionary = ["client_id": Constants.Credentials.clientID,
+            "client_secret": Constants.Credentials.clientSecret,
+            "grant_type": Constants.Credentials.grantRefreshToken,
+            "refresh_token": SessionManager.refreshToken()]
+        
+        let manager = APIManager.sharedInstance
+            manager.POST(url, parameters: params, success: {
+            (task: NSURLSessionDataTask!, responseObject: AnyObject!) in
+            
+            SVProgressHUD.dismiss()
+            
+            if (responseObject["isSuccessful"] as! Bool) {
+                SessionManager.parseTokensFromResponseObject(responseObject as! NSDictionary)
+                    self.fireUpdateProfile(url, params: params)
+                
+            } else {
+                self.showAlert("Error", message: responseObject["message"] as! String)
+            }
+            
+            }, failure: {
+                (task: NSURLSessionDataTask!, error: NSError!) in
+                SVProgressHUD.dismiss()
+                let task: NSHTTPURLResponse = task.response as! NSHTTPURLResponse
+                
+                self.showAlert("Something went wrong", message: "")
+                
+        })
+    }
+    
+    func showAlert(title: String, message: String) {
+        let alertController = UIAlertController(title: title, message: message, preferredStyle: .Alert)
+        
+        let OKAction = UIAlertAction(title: "OK", style: .Default) { (action) in
+            alertController.dismissViewControllerAnimated(true, completion: nil)
+        }
+        
+        alertController.addAction(OKAction)
+        
+        self.presentViewController(alertController, animated: true) {
+            
+        }
+    }
+
 }
diff --git a/YiLinkerOnlineBuyer/resources/ViewController/SearchViewController.swift b/YiLinkerOnlineBuyer/resources/ViewController/SearchViewController.swift
index a2529bb..3294f42 100644
--- a/YiLinkerOnlineBuyer/resources/ViewController/SearchViewController.swift
+++ b/YiLinkerOnlineBuyer/resources/ViewController/SearchViewController.swift
@@ -23,10 +23,6 @@ class SearchViewController: UIViewController, UITableViewDelegate, UITableViewDa
         super.viewDidLoad()
 
         self.initializeViews()
-        
-        let vc = FollowedSellerViewController(nibName: "FollowedSellerViewController", bundle: nil)
-        vc.edgesForExtendedLayout = UIRectEdge.None
-        self.navigationController?.pushViewController(vc, animated: true)
     }
 
     override func didReceiveMemoryWarning() {
diff --git a/YiLinkerOnlineBuyer/resources/ViewController/WishlistViewController.swift b/YiLinkerOnlineBuyer/resources/ViewController/WishlistViewController.swift
index b8c3218..f76d373 100644
--- a/YiLinkerOnlineBuyer/resources/ViewController/WishlistViewController.swift
+++ b/YiLinkerOnlineBuyer/resources/ViewController/WishlistViewController.swift
@@ -224,7 +224,6 @@ class WishlistViewController: UIViewController, UITableViewDelegate, UITableView
             let tempModel: WishlistProductDetailsModel = tableData[rowOfTheCell]
             
             var params: NSDictionary = ["access_token": SessionManager.accessToken(),
-                "wishlist": "true",
                 "productId": tempModel.id,
                 "unitId": tempModel.unitId,
                 "quantity": 0,
-- 
2.3.2 (Apple Git-55)

