From eb0041ee7104a29f46be29e9f0dc2fb65a51bf52 Mon Sep 17 00:00:00 2001
From: jpChan15 <john.chan@easyshop.ph>
Date: Sat, 29 Aug 2015 13:15:22 +0800
Subject: [PATCH 15/27] Resolved App crashes when Changing Name of some
 Accounts.

---
 ...itProfilePersonalInformationTableViewCell.swift |  21 ++--
 .../EditProfileTableViewController.swift           | 138 ++++++++++++++-------
 .../Xib/EditProfileAddPhotoTableViewCell.xib       |   2 +-
 ...EditProfilePersonalInformationTableViewCell.xib |   9 ++
 4 files changed, 117 insertions(+), 53 deletions(-)

diff --git a/YiLinkerOnlineBuyer/resources/View/EditProfilePersonalInformationTableViewCell.swift b/YiLinkerOnlineBuyer/resources/View/EditProfilePersonalInformationTableViewCell.swift
index a0c8a4a..7a29fca 100644
--- a/YiLinkerOnlineBuyer/resources/View/EditProfilePersonalInformationTableViewCell.swift
+++ b/YiLinkerOnlineBuyer/resources/View/EditProfilePersonalInformationTableViewCell.swift
@@ -8,21 +8,24 @@
 
 import UIKit
 
-class EditProfilePersonalInformationTableViewCell: UITableViewCell {
+protocol EditProfilePersonalInformationTableViewCellDelegate {
+    func passPersonalInformation(firstName: String, lastName: String, mobileNumber: String)
+}
+
+class EditProfilePersonalInformationTableViewCell: UITableViewCell, UITextFieldDelegate {
 
+    var delegate: EditProfilePersonalInformationTableViewCellDelegate?
+    
     @IBOutlet weak var firstNameTextField: UITextField!
     @IBOutlet weak var lastNameTextField: UITextField!
     @IBOutlet weak var mobilePhoneTextField: UITextField!
     
+    @IBAction func editingAction(sender: AnyObject) {
+        delegate?.passPersonalInformation(firstNameTextField.text, lastName: lastNameTextField.text, mobileNumber: mobilePhoneTextField.text)
+    }
+    
     override func awakeFromNib() {
         super.awakeFromNib()
-        // Initialization code
     }
-
-    override func setSelected(selected: Bool, animated: Bool) {
-        super.setSelected(selected, animated: animated)
-
-        // Configure the view for the selected state
-    }
-
+    
 }
diff --git a/YiLinkerOnlineBuyer/resources/ViewController/EditProfileTableViewController.swift b/YiLinkerOnlineBuyer/resources/ViewController/EditProfileTableViewController.swift
index 0fbc2c0..856e1c1 100644
--- a/YiLinkerOnlineBuyer/resources/ViewController/EditProfileTableViewController.swift
+++ b/YiLinkerOnlineBuyer/resources/ViewController/EditProfileTableViewController.swift
@@ -8,7 +8,7 @@
 
 import UIKit
 
-class EditProfileTableViewController: UITableViewController, UINavigationControllerDelegate, EditProfileAddPhotoTableViewCellDelegate, EditProfileAddressTableViewCellDelegate, EditProfileAccountInformationTableViewCellDelegate, UIImagePickerControllerDelegate, UIActionSheetDelegate  {
+class EditProfileTableViewController: UITableViewController, UINavigationControllerDelegate, EditProfileAddPhotoTableViewCellDelegate, EditProfileAddressTableViewCellDelegate, EditProfileAccountInformationTableViewCellDelegate, UIImagePickerControllerDelegate, UIActionSheetDelegate, EditProfilePersonalInformationTableViewCellDelegate  {
     
     let manager = APIManager.sharedInstance
     
@@ -29,6 +29,14 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
     
     var profileUserDetailsModel: ProfileUserDetailsModel!
     
+    var firstName: String = ""
+    var lastName: String = ""
+    var mobileNumber: String = ""
+    var emailAddress: String = ""
+    var password: String = ""
+    
+    var imageData: NSData?
+    
     override func viewDidLoad() {
         super.viewDidLoad()
         
@@ -57,6 +65,10 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
     
     func passModel(profileModel: ProfileUserDetailsModel){
         profileUserDetailsModel = profileModel
+        firstName = profileModel.firstName
+        lastName = profileModel.lastName
+        mobileNumber = profileModel.contactNumber
+        emailAddress = profileModel.email
     }
     
     func titleView() {
@@ -114,6 +126,13 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
             let cell = tableView.dequeueReusableCellWithIdentifier(addPhotoCellIndetifier, forIndexPath: indexPath) as! EditProfileAddPhotoTableViewCell
             cell.delegate = self
             
+            cell.profileImageView.sd_setImageWithURL(NSURL(string: profileUserDetailsModel.profileImageUrl), placeholderImage: UIImage(named: "dummy-placeholder"))
+            
+            if profileUserDetailsModel.profileImageUrl.isNotEmpty() {
+                cell.profileImageView.hidden = false
+                cell.addPhotoLabel.text = "Edit Photo"
+            }
+            
             photoIndexPath = indexPath
             
             return cell
@@ -122,7 +141,7 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
             cell.firstNameTextField.text = profileUserDetailsModel.firstName
             cell.lastNameTextField.text = profileUserDetailsModel.lastName
             cell.mobilePhoneTextField.text = profileUserDetailsModel.contactNumber
-            
+            cell.delegate = self
             personalIndexPath = indexPath
             
             return cell
@@ -258,6 +277,8 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
         addPhotoCell!.profileImageView.hidden = false
         addPhotoCell!.profileImageView.image = image
         addPhotoCell!.addPhotoLabel.text = "Edit Photo"
+        
+        imageData = UIImagePNGRepresentation(image)
     }
     
     func actionSheet(actionSheet: UIActionSheet, clickedButtonAtIndex buttonIndex: Int) {
@@ -297,52 +318,61 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
         self.view.endEditing(true)
     }
     
+    // MARK: - EditProfilePersonalInformationTableViewCellDelegate
+    func passPersonalInformation(firstName: String, lastName: String, mobileNumber: String) {
+        self.firstName = firstName
+        self.lastName = lastName
+        self.mobileNumber = mobileNumber
+    }
+    
     // MARK: - EditProfileAccountInformationTableViewCellDelegate
     func saveAction(sender: AnyObject) {
         println("saveAction")
         
         var errorMessage: String = ""
         
-        addPhotoCell = self.tableView.cellForRowAtIndexPath(photoIndexPath!) as? EditProfileAddPhotoTableViewCell
-        personalInfoCell = self.tableView.cellForRowAtIndexPath(personalIndexPath!) as? EditProfilePersonalInformationTableViewCell
-        addressCell = self.tableView.cellForRowAtIndexPath(addressIndexPath!) as? EditProfileAddressTableViewCell
-        accountCell = self.tableView.cellForRowAtIndexPath(accountIndexPath!) as? EditProfileAccountInformationTableViewCell
-        
-        let firstName = personalInfoCell?.firstNameTextField.text
-        let lastName = personalInfoCell?.lastNameTextField.text
-        let mobileNumber = personalInfoCell?.mobilePhoneTextField.text
-        let emailAddress = accountCell?.emailAddressTextField.text
-        let password = accountCell?.passwordTextField.text
-        
-        if !firstName!.isNotEmpty() {
+        /*
+        if firstName.isEmpty {
             errorMessage = "First name is required."
-        } else if !firstName!.isValidName() {
+        } else if firstName.isValidName() {
             errorMessage = "First name contains illegal characters. It can only contain letters, numbers and underscores."
-        } else if !lastName!.isNotEmpty() {
+        } else if lastName.isNotEmpty() {
             errorMessage = "Last name is required."
-        } else if !lastName!.isValidName() {
+        } else if lastName.isValidName() {
             errorMessage = "Last name contains illegal characters. It can only contain letters, numbers and underscores."
-        } else if !emailAddress!.isNotEmpty() {
+        } else if emailAddress.isNotEmpty() {
             errorMessage = "Email is required."
-        } else if !emailAddress!.isValidEmail() {
+        } else if emailAddress.isValidEmail() {
             errorMessage = "The email address you enter is not a valid email address."
-        } else if !password!.isNotEmpty() {
+        } else if password.isNotEmpty() {
             errorMessage = "Password is required."
-        } else if !password!.isAlphaNumeric() {
+        } else if password.isAlphaNumeric() {
             errorMessage = "Password contains illegal characters. It can only contain letters, numbers and underscores."
-        }
+        }*/
         
         if errorMessage != "" {
             UIAlertController.displayErrorMessageWithTarget(self, errorMessage: errorMessage)
         } else {
             if Reachability.isConnectedToNetwork(){
-                var params: NSDictionary = [
-                    "firstName": firstName! as String,
-                    "lastName": lastName! as String,
-                    "contactNumber": mobileNumber! as String,
-                    "access_token": SessionManager.accessToken()]
+                if imageData != nil{
+                    var params: NSDictionary = [
+                        "firstName": firstName as String,
+                        "lastName": lastName as String,
+                        "contactNumber": mobileNumber as String,
+                        "access_token": SessionManager.accessToken()]
+                    
+                    fireUpdateProfile(APIAtlas.editProfileUrl, params: params, withImage: true)
+                } else {
+                    var params: NSDictionary = [
+                        "firstName": firstName as String,
+                        "lastName": lastName as String,
+                        "profilePhoto": profileUserDetailsModel.profileImageUrl as String,
+                        "contactNumber": mobileNumber as String,
+                        "access_token": SessionManager.accessToken()]
+                    
+                    fireUpdateProfile(APIAtlas.editProfileUrl, params: params, withImage: false)
+                }
                 
-                fireUpdateProfile(APIAtlas.editProfileUrl, params: params)
             }
             else {
                 showAlert("Connection Unreachable", message: "Cannot retrieve data. Please check your internet connection.")
@@ -352,20 +382,42 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
     }
     
     
-    func fireUpdateProfile(url: String, params: NSDictionary!) {
+    func fireUpdateProfile(url: String, params: NSDictionary!, withImage: Bool) {
         showLoader()
-        manager.POST(url, parameters: params, success: {
-            (task: NSURLSessionDataTask!, responseObject: AnyObject!) in print(responseObject as! NSDictionary)
-            if responseObject.objectForKey("error") != nil {
-                self.requestRefreshToken("updateProfile", url: url, params: params)
-            }
-            self.dismissLoader()
-            self.showAlert("Success", message: "Successfully updated profile!")
-            }, failure: {
-                (task: NSURLSessionDataTask!, error: NSError!) in
-                self.showAlert("Error", message: "Something went wrong. . .")
-                self.dismissLoader()
-        })
+        if withImage {
+            manager.POST(url, parameters: params, constructingBodyWithBlock: { (data: AFMultipartFormData!) in
+                println("")
+                data.appendPartWithFileData(self.imageData!, name: "profilePhoto", fileName: "photo", mimeType: "")
+                }, success: {
+                    (task: NSURLSessionDataTask!, responseObject: AnyObject!) in print(responseObject as! NSDictionary)
+                    if responseObject.objectForKey("error") != nil {
+                        self.requestRefreshToken("updateProfile", url: url, params: params, withImage: withImage)
+                    }
+                    self.dismissLoader()
+                    self.showAlert("Success", message: "Successfully updated profile!")
+                }, failure: {
+                    (task: NSURLSessionDataTask!, error: NSError!) in
+                    self.showAlert("Error", message: "Something went wrong. . .")
+                    self.dismissLoader()
+                    println(error)
+            })
+        } else {
+            manager.POST(url, parameters: params, success: {
+                    (task: NSURLSessionDataTask!, responseObject: AnyObject!) in print(responseObject as! NSDictionary)
+                    if responseObject.objectForKey("error") != nil {
+                        self.requestRefreshToken("updateProfile", url: url, params: params, withImage: withImage)
+                    }
+                    self.dismissLoader()
+                    self.showAlert("Success", message: "Successfully updated profile!")
+                    println(responseObject)
+                }, failure: {
+                    (task: NSURLSessionDataTask!, error: NSError!) in
+                    self.showAlert("Error", message: "Something went wrong. . .")
+                    self.dismissLoader()
+                    println(error)
+            })
+        }
+        
     }
     
     //Loader function
@@ -378,7 +430,7 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
         SVProgressHUD.dismiss()
     }
     
-    func requestRefreshToken(type: String, url: String, params: NSDictionary!) {
+    func requestRefreshToken(type: String, url: String, params: NSDictionary!, withImage: Bool) {
         let url: String = "http://online.api.easydeal.ph/api/v1/login"
         let params: NSDictionary = ["client_id": Constants.Credentials.clientID,
             "client_secret": Constants.Credentials.clientSecret,
@@ -393,7 +445,7 @@ class EditProfileTableViewController: UITableViewController, UINavigationControl
             
             if (responseObject["isSuccessful"] as! Bool) {
                 SessionManager.parseTokensFromResponseObject(responseObject as! NSDictionary)
-                    self.fireUpdateProfile(url, params: params)
+                self.fireUpdateProfile(url, params: params, withImage: withImage)
                 
             } else {
                 self.showAlert("Error", message: responseObject["message"] as! String)
diff --git a/YiLinkerOnlineBuyer/resources/Xib/EditProfileAddPhotoTableViewCell.xib b/YiLinkerOnlineBuyer/resources/Xib/EditProfileAddPhotoTableViewCell.xib
index 5ca1642..d9560e2 100644
--- a/YiLinkerOnlineBuyer/resources/Xib/EditProfileAddPhotoTableViewCell.xib
+++ b/YiLinkerOnlineBuyer/resources/Xib/EditProfileAddPhotoTableViewCell.xib
@@ -51,6 +51,6 @@
     </objects>
     <resources>
         <image name="dummy-placeholder" width="1280" height="800"/>
-        <image name="photo" width="66" height="53"/>
+        <image name="photo" width="200" height="159"/>
     </resources>
 </document>
diff --git a/YiLinkerOnlineBuyer/resources/Xib/EditProfilePersonalInformationTableViewCell.xib b/YiLinkerOnlineBuyer/resources/Xib/EditProfilePersonalInformationTableViewCell.xib
index 9f267c4..7ce6112 100644
--- a/YiLinkerOnlineBuyer/resources/Xib/EditProfilePersonalInformationTableViewCell.xib
+++ b/YiLinkerOnlineBuyer/resources/Xib/EditProfilePersonalInformationTableViewCell.xib
@@ -56,6 +56,9 @@
                         <color key="textColor" white="0.66666666666666663" alpha="1" colorSpace="calibratedWhite"/>
                         <fontDescription key="fontDescription" type="system" pointSize="12"/>
                         <textInputTraits key="textInputTraits"/>
+                        <connections>
+                            <action selector="editingAction:" destination="3XT-ns-6vO" eventType="editingChanged" id="ZjL-iA-Sl0"/>
+                        </connections>
                     </textField>
                     <label opaque="NO" userInteractionEnabled="NO" contentMode="left" horizontalHuggingPriority="251" verticalHuggingPriority="251" usesAttributedText="YES" lineBreakMode="tailTruncation" baselineAdjustment="alignBaselines" adjustsFontSizeToFit="NO" translatesAutoresizingMaskIntoConstraints="NO" id="Tgb-o1-qLm">
                         <rect key="frame" x="8" y="102" width="175" height="21"/>
@@ -81,6 +84,9 @@
                         <color key="textColor" white="0.66666666666666663" alpha="1" colorSpace="calibratedWhite"/>
                         <fontDescription key="fontDescription" type="system" pointSize="12"/>
                         <textInputTraits key="textInputTraits" keyboardType="numberPad"/>
+                        <connections>
+                            <action selector="editingAction:" destination="3XT-ns-6vO" eventType="editingDidEnd" id="zMN-XG-Kfw"/>
+                        </connections>
                     </textField>
                     <textField opaque="NO" clipsSubviews="YES" contentMode="scaleToFill" contentHorizontalAlignment="left" contentVerticalAlignment="center" text="Dalism" borderStyle="roundedRect" minimumFontSize="17" translatesAutoresizingMaskIntoConstraints="NO" id="pNa-IP-8ln">
                         <rect key="frame" x="191" y="64" width="175" height="30"/>
@@ -90,6 +96,9 @@
                         <color key="textColor" white="0.66666666666666663" alpha="1" colorSpace="calibratedWhite"/>
                         <fontDescription key="fontDescription" type="system" pointSize="12"/>
                         <textInputTraits key="textInputTraits"/>
+                        <connections>
+                            <action selector="editingAction:" destination="3XT-ns-6vO" eventType="editingDidEnd" id="Icd-su-3Ot"/>
+                        </connections>
                     </textField>
                     <label opaque="NO" userInteractionEnabled="NO" contentMode="left" horizontalHuggingPriority="251" verticalHuggingPriority="251" usesAttributedText="YES" lineBreakMode="tailTruncation" baselineAdjustment="alignBaselines" adjustsFontSizeToFit="NO" translatesAutoresizingMaskIntoConstraints="NO" id="QYK-jr-zIY">
                         <rect key="frame" x="191" y="43" width="175" height="21"/>
-- 
2.3.2 (Apple Git-55)

